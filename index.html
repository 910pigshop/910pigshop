<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>910è±¬å¼ä¼šç¤¾ å ±åƒ¹ç³»çµ±</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="910å ±åƒ¹">
    
    <style>
        :root { --bg: #f2f2f7; --card: #ffffff; --blue: #007aff; --orange: #ff9500; --gray: #8e8e93; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; }
        .header { text-align: center; padding: 20px 0; font-size: 20px; font-weight: 900; background: var(--card); box-shadow: 0 1px 10px rgba(0,0,0,0.05); }
        .container { padding: 15px; display: none; }
        .container.active { display: block; }
        
        .input-group-grid { 
            background: var(--card); padding: 20px 15px; border-radius: 20px; margin-bottom: 20px; 
            display: grid; grid-template-columns: 1fr 1fr; column-gap: 20px; row-gap: 12px; justify-items: center; 
        }
        .jpy-row { 
            display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f2f2f7; padding-bottom: 4px; 
            width: 100%; max-width: 140px; 
        }
        .jpy-row span { color: var(--gray); font-weight: bold; width: 22px; font-size: 13px; text-align: center; }
        .jpy-input-item { flex: 1; border: none; font-size: 16px; font-weight: bold; padding: 4px; outline: none; text-align: right; background: none; width: 60px; }

        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .photo-card { background: var(--card); padding: 12px; border-radius: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-name { font-weight: 800; font-size: 14px; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-controls { display: flex; align-items: center; justify-content: space-between; }
        .price-tag { color: var(--blue); font-weight: bold; font-size: 14px; }
        
        /* èª¿æ•´æ­¥é€²å™¨æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†å¯¬åº¦ */
        .stepper { display: flex; align-items: center; gap: 2px; background: #f2f2f7; border-radius: 8px; padding: 2px; }
        .btn-step { 
            background: none; border: none; color: var(--blue); font-size: 18px; 
            width: 24px; height: 28px; border-radius: 6px; font-weight: 900; 
            display: flex; align-items: center; justify-content: center;
        }
        .btn-step:active { background: #e5e5ea; }
        .count-input { 
            width: 40px; text-align: center; border: none; background: none; 
            font-weight: bold; font-size: 15px; outline: none; padding: 0;
        }
        
        .report-box { background: #fff; border-radius: 20px; padding: 15px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .report-textarea { width: 100%; height: 250px; background: #f8f8f8; border: 1px solid #eee; border-radius: 10px; padding: 10px; box-sizing: border-box; font-family: monospace; font-size: 14px; margin-bottom: 10px; }
        
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card-edit-box { background: var(--card); padding: 10px; border-radius: 12px; border: 1px solid #e5e5ea; }
        .full-input { width: 100%; border: none; border-bottom: 1px solid #eee; padding: 5px 0; margin-bottom: 8px; font-weight: bold; font-size: 12px; outline: none; }
        .settings-group { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f2f2f7; }
        .settings-input-wrapper { display: flex; align-items: center; gap: 4px; }
        .settings-input { border: 1.5px solid #d1d1d6; border-radius: 6px; padding: 4px; width: 48px; text-align: right; font-size: 14px; outline: none; }
        
        .btn-main { background: var(--blue); color: #fff; border: none; width: 100%; padding: 16px; border-radius: 14px; font-weight: bold; font-size: 17px; margin-top: 10px; }
        .btn-gen-small { background: var(--blue); color: #fff; border: none; padding: 8px 12px; border-radius: 10px; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .profit-text { text-align: center; font-weight: bold; color: #34c759; margin: 10px 0; font-size: 17px; }

        .tabs { display: flex; justify-content: space-around; position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 12px 0 34px; border-top: 1px solid #d1d1d6; z-index: 100; }
        .tab-item { text-align: center; color: var(--gray); font-size: 11px; flex: 1; text-decoration: none; cursor: pointer; }
        .tab-item.active { color: var(--blue); }
        .tab-icon { font-size: 22px; display: block; margin-bottom: 4px; }
    </style>
</head>
<body onclick="hideKeyboard(event)">
    <div class="header">910è±¬å¼ä¼šç¤¾ å ±åƒ¹ç³»çµ±(è³£å®¶)</div>

    <div id="tab0" class="container active">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0; font-size: 18px;">ğŸ“¸ ç›¸å¡å ±åƒ¹</h2>
            <button onclick="resetCounts()" style="color:var(--gray); border:none; background:none; font-size:14px;">é‡ç½®å¼µæ•¸</button>
        </div>
        <div class="card-grid" id="photo-card-list"></div>
        <button class="btn-main" onclick="generatePhotoReport()">ğŸ” ç”Ÿæˆå ±åƒ¹</button>
        <div id="photo-report-area" class="report-box" style="display:none">
            <textarea id="photo-report-text" class="report-textarea" readonly></textarea>
            <div id="photo-profit-val" class="profit-text"></div>
            <button class="btn-main" style="background:#000" onclick="copyText('photo-report-text')">è¤‡è£½å ±åƒ¹æ–‡å­—</button>
        </div>
    </div>

    <div id="tab1" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0; font-size: 18px;">ğŸ“¦ å•†å“å ±åƒ¹</h2>
            <button onclick="resetProducts()" style="color:var(--gray); border:none; background:none; font-size:14px;">é‡ç½®å…§å®¹</button>
        </div>
        <div class="input-group-grid" id="jpy-inputs-container"></div>
        <div id="product-results"></div>
        <div id="product-report-area" class="report-box" style="display:none">
            <textarea id="product-report-text" class="report-textarea" readonly></textarea>
            <div id="product-profit-val" class="profit-text"></div>
            <button class="btn-main" style="background:#000" onclick="copyText('product-report-text')">è¤‡è£½å ±åƒ¹æ–‡å­—</button>
        </div>
    </div>

    <div id="tab2" class="container">
        <h2 style="font-size: 18px;">âš™ï¸ ç³»çµ±è¨­å®š</h2>
        <div class="settings-group" id="settings-fields"></div>
        <h3 style="font-size: 16px; margin-left: 5px;">ç›¸å¡éšæ¢¯å ±åƒ¹å®šç¾©</h3>
        <div id="card-settings-list" class="settings-grid"></div>
    </div>

    <nav class="tabs">
        <div class="tab-item active" onclick="showTab(0)"><span class="tab-icon">ğŸ–¼ï¸</span>ç›¸å¡å ±åƒ¹</div>
        <div class="tab-item" onclick="showTab(1)"><span class="tab-icon">ğŸ“¦</span>å•†å“å ±åƒ¹</div>
        <div class="tab-item" onclick="showTab(2)"><span class="tab-icon">âš™ï¸</span>ç³»çµ±è¨­å®š</div>
    </nav>

    <script>
        const defaultCards = [
            {name: "Lawson/å…¨å®¶--Låˆ¤", jpy: 30, twd: 15, twd25: 14, twd50: 13.5, count: 0},
            {name: "7-11--Låˆ¤", jpy: 40, twd: 18, twd25: 17, twd50: 16.5, count: 0},
            {name: "Lawson/å…¨å®¶--2Låˆ¤", jpy: 80, twd: 28, twd25: 27, twd50: 26.5, count: 0},
            {name: "7-11--2Låˆ¤", jpy: 100, twd: 33, twd25: 32, twd50: 31.5, count: 0},
            {name: "Lawson/å…¨å®¶--æ˜ä¿¡ç‰‡", jpy: 70, twd: 25, twd25: 24, twd50: 23.5, count: 0},
            {name: "7-11--æ˜ä¿¡ç‰‡", jpy: 60, twd: 23, twd25: 22, twd50: 21.5, count: 0},
            {name: "è‡ªå®šç¾©ç›¸å¡ G", jpy: 0, twd: 0, twd25: 0, twd50: 0, count: 0},
            {name: "è‡ªå®šç¾©ç›¸å¡ H", jpy: 0, twd: 0, twd25: 0, twd50: 0, count: 0},
            {name: "å®˜æ–¹ç›¸å¡/è²¼ç´™(Â¥200)", jpy: 200, twd: 60, twd25: 57, twd50: 55, count: 0},
            {name: "å®˜æ–¹ç›¸å¡/è²¼ç´™(Â¥250)", jpy: 250, twd: 75, twd25: 71, twd50: 69, count: 0},
            {name: "å®˜æ–¹ç›¸å¡/è²¼ç´™(Â¥300)", jpy: 300, twd: 90, twd25: 85.5, twd50: 83, count: 0},
            {name: "å®˜æ–¹ç›¸å¡/è²¼ç´™(Â¥500)", jpy: 500, twd: 150, twd25: 142, twd50: 138, count: 0}
        ];

        let settings = JSON.parse(localStorage.getItem('910Settings_V17')) || {
            realRate: 0.20, pubRate: 0.22, pct1: 17.5, pct2: 15, pct3: 20,
            cards: defaultCards
        };

        function saveData(shouldRender = true) { 
            localStorage.setItem('910Settings_V17', JSON.stringify(settings)); 
            if(shouldRender) renderAll(); 
        }

        function renderAll() {
            const jContainer = document.getElementById('jpy-inputs-container');
            if(jContainer.innerHTML.trim() === "") {
                for(let i=1; i<=10; i++) {
                    jContainer.innerHTML += `<div class="jpy-row"><span>${i}.</span><input type="number" class="jpy-input-item jpy-field" placeholder="0" oninput="calcProduct()"></div>`;
                }
            }
            updateCardListDisplay();
            document.getElementById('settings-fields').innerHTML = `
                <div class="settings-item"><span>æˆæœ¬åŒ¯ç‡</span><input class="settings-input" type="number" step="0.001" value="${settings.realRate}" onchange="settings.realRate=parseFloat(this.value);saveData()"></div>
                <div class="settings-item"><span>å…¬å‘ŠåŒ¯ç‡</span><input class="settings-input" type="number" step="0.001" value="${settings.pubRate}" onchange="settings.pubRate=parseFloat(this.value);saveData()"></div>
                <div class="settings-item"><span>äºŒæ‰‹å•†å“åˆ©æ½¤</span><div class="settings-input-wrapper"><input class="settings-input" type="number" value="${settings.pct1}" onchange="settings.pct1=parseFloat(this.value);saveData()">%</div></div>
                <div class="settings-item"><span>ç¶²è·¯é€šè²©åˆ©æ½¤</span><div class="settings-input-wrapper"><input class="settings-input" type="number" value="${settings.pct2}" onchange="settings.pct2=parseFloat(this.value);saveData()">%</div></div>
                <div class="settings-item"><span>ç¾åœ°ä»£è³¼åˆ©æ½¤</span><div class="settings-input-wrapper"><input class="settings-input" type="number" value="${settings.pct3}" onchange="settings.pct3=parseFloat(this.value);saveData()">%</div></div>
            `;
            document.getElementById('card-settings-list').innerHTML = settings.cards.map((c, i) => `
                <div class="card-edit-box">
                    <input class="full-input" value="${c.name}" onchange="settings.cards[${i}].name=this.value;saveData()">
                    <div class="price-row" style="font-size:11px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:3px;">æ—¥å¹£: <input type="number" class="settings-input" value="${c.jpy}" onchange="settings.cards[${i}].jpy=parseFloat(this.value);saveData()"></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:3px;">å–®å¼µ: <input type="number" class="settings-input" value="${c.twd}" onchange="settings.cards[${i}].twd=parseFloat(this.value);saveData()"></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:3px; color:var(--orange)">25+: <input type="number" class="settings-input" value="${c.twd25}" onchange="settings.cards[${i}].twd25=parseFloat(this.value);saveData()"></div>
                        <div style="display:flex; justify-content:space-between; color:var(--orange)">50+: <input type="number" class="settings-input" value="${c.twd50}" onchange="settings.cards[${i}].twd50=parseFloat(this.value);saveData()"></div>
                    </div>
                </div>`).join('');
        }

        function updateCardListDisplay() {
            const totalCount = settings.cards.reduce((sum, c) => sum + (parseInt(c.count) || 0), 0);
            const list = document.getElementById('photo-card-list');
            list.innerHTML = settings.cards.map((c, i) => {
                let p = c.twd;
                if (totalCount >= 50 && c.twd50 > 0) p = c.twd50;
                else if (totalCount >= 25 && c.twd25 > 0) p = c.twd25;
                return `<div class="photo-card"><div class="card-name">${c.name}</div><div class="card-controls"><span class="price-tag">$${p}</span><div class="stepper"><button class="btn-step" onclick="updateCount(${i},-1)">-</button><input type="number" class="count-input" value="${c.count}" oninput="setCount(${i},this.value)"><button class="btn-step" onclick="updateCount(${i},1)">+</button></div></div></div>`;
            }).join('');
        }

        function updateCount(i, delta) { 
            settings.cards[i].count = Math.max(0, settings.cards[i].count + delta); 
            saveData(true); 
        }

        function setCount(i, v) { 
            settings.cards[i].count = Math.max(0, parseInt(v) || 0); 
            localStorage.setItem('910Settings_V17', JSON.stringify(settings)); 
        }
        
        function resetCounts() { 
            settings.cards.forEach(c => c.count = 0); 
            document.getElementById('photo-report-area').style.display='none'; 
            saveData(true); 
        }

        function resetProducts() {
            const fields = document.querySelectorAll('.jpy-field');
            fields.forEach(f => f.value = "");
            document.getElementById('product-results').innerHTML = "";
            document.getElementById('product-report-area').style.display = 'none';
        }

        function showTab(idx) { 
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active')); 
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active')); 
            document.getElementById('tab'+idx).classList.add('active'); 
            document.querySelectorAll('.tab-item')[idx].classList.add('active'); 
            if(idx === 0) updateCardListDisplay(); 
        }

        function generatePhotoReport() {
            const actives = settings.cards.filter(c => c.count > 0);
            if(actives.length === 0) return;
            const totalCount = actives.reduce((sum, c) => sum + c.count, 0);
            let totalTwd = 0, totalJpy = 0;
            let text = `ğŸ“¸ ç›¸å¡å ±åƒ¹ (ç¸½è¨ˆ ${totalCount} å¼µ)\n------------------\n`;
            
            actives.forEach(c => {
                let p = c.twd;
                if (totalCount >= 50 && c.twd50 > 0) p = c.twd50;
                else if (totalCount >= 25 && c.twd25 > 0) p = c.twd25;
                
                // æ˜ç´°é¡¯ç¤ºå¯¦éš›è¨ˆç®—çµæœ
                let sub = p * c.count;
                
                text += `â–«ï¸ ${c.name}\n   ${p}å…ƒ Ã— ${c.count}å¼µ = $${sub}\n`;
                totalTwd += sub; totalJpy += (c.jpy * c.count);
            });

            // ç¸½è¨ˆé€²ä½é‚è¼¯ï¼šåªè¦æœ‰å°æ•¸é»å°±ç„¡æ¢ä»¶é€² 1 åˆ°æ•´æ•¸
            const finalTwd = Math.ceil(totalTwd);

            const profit = Math.floor(finalTwd - (totalJpy * settings.realRate));
            text += `------------------\nç¸½è¨ˆé‡‘é¡ï¼šNT$ ${finalTwd}\n(ä¸å«åœ‹éš›é‹è²»&å°ç£é‹è²»)\n\nğŸ’¡å†å¹«æˆ‘ç¢ºèªå¼µæ•¸è·Ÿé‡‘é¡æ˜¯å¦éƒ½æ­£ç¢º\nå…§å®¹æ­£ç¢ºè«‹å†ç›´æ¥å®ŒæˆåŒ¯æ¬¾ è¬è¬`;
            
            document.getElementById('photo-report-text').value = text;
            document.getElementById('photo-profit-val').innerText = "é ä¼°åˆ©æ½¤ï¼šNT$ " + profit;
            document.getElementById('photo-report-area').style.display = 'block';
            window.scrollTo(0, document.body.scrollHeight);
            updateCardListDisplay();
        }

        function calcProduct() {
            const fields = document.querySelectorAll('.jpy-field');
            const jpyValues = Array.from(fields).map(f => parseFloat(f.value) || 0).filter(v => v > 0);
            if(jpyValues.length === 0) { document.getElementById('product-results').innerHTML = ""; return; }
            const types = [{t:"äºŒæ‰‹å•†å“", p:settings.pct1}, {t:"ç¶²è·¯é€šè²©", p:settings.pct2}, {t:"ç¾åœ°ä»£è³¼", p:settings.pct3}];
            
            document.getElementById('product-results').innerHTML = types.map(r => {
                let totalTwd = 0; let totalProfit = 0; let priceListText = "";
                jpyValues.forEach((v, idx) => {
                    const twd = Math.ceil((v * settings.pubRate * (1 + r.p/100)) / 5) * 5;
                    const profit = Math.floor(twd - (v * settings.realRate));
                    totalTwd += twd; totalProfit += profit;
                    priceListText += jpyValues.length > 1 ? `${idx+1}.${twd}å…ƒ\n` : `${twd}å…ƒ\n`;
                });
                const reportStr = `æ‚¨å¥½  æ„Ÿè¬è©¢å•âœ¨âœ¨\nä»¥ä¸Šç‰©å“å ±åƒ¹\n------------------\n${priceListText}(ä¸å«åœ‹éš›é‹è²»&å°ç£é‹è²»)\n------------------\nç¸½è¨ˆé‡‘é¡ï¼šNT$ ${totalTwd}\nåŒ¯æ¬¾æ–¹å¼ï¼šATMåŒ¯æ¬¾ã€è‡¨æ«ƒåŒ¯æ¬¾ã€ç„¡å¡åŒ¯æ¬¾(éœ€å…ˆç¢ºèªéœ€åŒ¯æ¬¾é‡‘é¡)`;
                return `
                <div class="settings-group" style="display:flex; justify-content:space-between; align-items:center; padding: 10px;">
                    <div><span style="font-size:11px; color:gray;">${r.t}(${jpyValues.length}ä»¶)</span><br><b style="font-size:18px;">$${totalTwd}</b></div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <div style="text-align:right;"><span style="font-size:10px; color:gray;">åˆ©æ½¤</span><br><b style="color:#34c759; font-size:14px;">+${totalProfit}</b></div>
                        <button class="btn-gen-small" onclick="triggerProductReport(\`${reportStr}\`, ${totalProfit})">ğŸ” ç”Ÿæˆå ±åƒ¹</button>
                    </div>
                </div>`;
            }).join('');
        }

        function triggerProductReport(str, profit) {
            document.getElementById('product-report-text').value = str;
            document.getElementById('product-profit-val').innerText = "é ä¼°ç¸½åˆ©æ½¤ï¼šNT$ " + profit;
            document.getElementById('product-report-area').style.display = 'block';
            window.scrollTo(0, document.body.scrollHeight);
        }

        function copyText(id) {
            const el = document.getElementById(id);
            el.select(); el.setSelectionRange(0, 99999);
            document.execCommand('copy');
            alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        }

        function hideKeyboard(e) { 
            if(!['INPUT','TEXTAREA'].includes(e.target.tagName)) { 
                document.activeElement.blur(); 
                updateCardListDisplay(); 
            } 
        }
        renderAll();
    </script>
</body>
</html>
